# HAProxy Configuration for Xray Multi-Protocol
# Path-based routing on port 443 and 80

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # SSL/TLS Configuration
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

# ============================================
# FRONTEND - Port 443 (TLS)
# ============================================

frontend https_frontend
    bind *:443 ssl crt /etc/xray/fullchain.pem alpn h2,http/1.1
    mode http
    
    # ACL untuk routing berdasarkan path
    acl is_vmess path_beg /vmess
    acl is_vmess_grpc path_beg /vmess-grpc
    acl is_vless path_beg /vless
    acl is_vless_grpc path_beg /vless-grpc
    acl is_trojan path_beg /trojan
    acl is_trojan_grpc path_beg /trojan-grpc
    acl is_shadowsocks path_beg /shadowsocks
    
    # Routing ke backend
    use_backend vmess_backend if is_vmess
    use_backend vmess_grpc_backend if is_vmess_grpc
    use_backend vless_backend if is_vless
    use_backend vless_grpc_backend if is_vless_grpc
    use_backend trojan_backend if is_trojan
    use_backend trojan_grpc_backend if is_trojan_grpc
    use_backend shadowsocks_backend if is_shadowsocks
    
    # Default backend
    default_backend vmess_backend

# ============================================
# FRONTEND - Port 80 (Non-TLS)
# ============================================

frontend http_frontend
    bind *:80
    mode http
    
    # ACL untuk routing berdasarkan path
    acl is_vmess path_beg /vmess
    acl is_vless path_beg /vless
    
    # Routing ke backend
    use_backend vmess_nontls_backend if is_vmess
    use_backend vless_nontls_backend if is_vless
    
    # Default backend
    default_backend vmess_nontls_backend

# ============================================
# BACKEND - Xray Services
# ============================================

backend vmess_backend
    mode http
    server xray_vmess 127.0.0.1:10001 check

backend vmess_grpc_backend
    mode http
    server xray_vmess_grpc 127.0.0.1:10002 check

backend vless_backend
    mode http
    server xray_vless 127.0.0.1:10003 check

backend vless_grpc_backend
    mode http
    server xray_vless_grpc 127.0.0.1:10004 check

backend trojan_backend
    mode http
    server xray_trojan 127.0.0.1:10005 check

backend trojan_grpc_backend
    mode http
    server xray_trojan_grpc 127.0.0.1:10006 check

backend shadowsocks_backend
    mode http
    server xray_ss 127.0.0.1:10007 check

backend vmess_nontls_backend
    mode http
    server xray_vmess_nontls 127.0.0.1:10011 check

backend vless_nontls_backend
    mode http
    server xray_vless_nontls 127.0.0.1:10012 check
